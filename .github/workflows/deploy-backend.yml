name: Deploy Backend to Elastic Beanstalk

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Quick secrets check (fail early if missing)
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then echo "Missing AWS_ACCESS_KEY_ID"; exit 1; fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then echo "Missing AWS_SECRET_ACCESS_KEY"; exit 1; fi
          if [ -z "${{ secrets.AWS_REGION }}" ]; then echo "Missing AWS_REGION"; exit 1; fi
          if [ -z "${{ secrets.EB_S3_BUCKET }}" ]; then echo "Missing EB_S3_BUCKET"; exit 1; fi
          if [ -z "${{ secrets.EB_APP_NAME }}" ]; then echo "Missing EB_APP_NAME"; exit 1; fi
          if [ -z "${{ secrets.EB_ENV_NAME }}" ]; then echo "Missing EB_ENV_NAME"; exit 1; fi
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        working-directory: server
        run: |
          if [ -f package.json ]; then npm ci --production || npm ci; fi

      - name: Create deployment package (zip)
        run: |
          rm -f backend-deploy.zip
          zip -r backend-deploy.zip server -x "server/node_modules/*" "server/.git/*"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload zip to S3 (artifact bucket)
        id: upload
        run: |
          TIMESTAMP=$(date +%s)
          KEY="eb-deployments/backend-${{ github.run_id }}-${TIMESTAMP}.zip"
          aws s3 cp backend-deploy.zip s3://${{ secrets.EB_S3_BUCKET }}/$KEY
          echo "s3key=$KEY" >> $GITHUB_OUTPUT

      - name: Create application version in Elastic Beanstalk
        run: |
          VERSION_LABEL="gh-${{ github.run_id }}-${{ github.sha::7 }}"
          aws elasticbeanstalk create-application-version \
            --application-name "${{ secrets.EB_APP_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="${{ secrets.EB_S3_BUCKET }}",S3Key="${{ steps.upload.outputs.s3key }}"

      - name: Update environment variables (set GEMINI_API_KEY) and deploy version
        run: |
          VERSION_LABEL="gh-${{ github.run_id }}-${{ github.sha::7 }}"
          aws elasticbeanstalk update-environment \
            --environment-name "${{ secrets.EB_ENV_NAME }}" \
            --option-settings Namespace=aws:elasticbeanstalk:application:environment,OptionName=GEMINI_API_KEY,Value="${{ secrets.GEMINI_API_KEY }}" \
            --version-label "$VERSION_LABEL"

      - name: Wait for environment update (poll)
        run: |
          echo "Waiting for environment to become Ready & Green..."
          END=$((SECONDS + 600))
          while [ $SECONDS -lt $END ]; do
            STATUS=$(aws elasticbeanstalk describe-environments --environment-names "${{ secrets.EB_ENV_NAME }}" --query "Environments[0].Status" --output text)
            HEALTH=$(aws elasticbeanstalk describe-environments --environment-names "${{ secrets.EB_ENV_NAME }}" --query "Environments[0].Health" --output text)
            echo "Status: $STATUS  Health: $HEALTH"
            if [ "$STATUS" = "Ready" ] && [ "$HEALTH" = "Green" ]; then
              echo "Environment healthy."
              exit 0
            fi
            sleep 10
          done
          echo "Timed out waiting for EB environment to be healthy."
          exit 1

      - name: Done
        run: echo "Backend deployment completed."
